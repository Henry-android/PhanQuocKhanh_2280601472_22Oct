<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Images - ƒêƒÉng Nh·∫≠p</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #6366f1 0%,
          #8b5cf6 50%,
          #ec4899 100%
        );
        min-height: 100vh;
        padding: 20px;
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(139, 92, 246, 0.3) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(236, 72, 153, 0.3) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        animation: fadeInDown 0.8s ease;
      }

      .header h1 {
        font-size: 3.5em;
        margin-bottom: 15px;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        font-weight: 700;
        background: linear-gradient(to right, #fff, #f0abfc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header p {
        font-size: 1.3em;
        opacity: 0.95;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      /* Authentication Section */
      .auth-container {
        display: none;
        max-width: 500px;
        margin: 0 auto;
      }

      .auth-container.active {
        display: block;
      }

      .auth-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        padding: 45px;
        border-radius: 24px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25),
          0 0 0 1px rgba(255, 255, 255, 0.3);
        animation: fadeInUp 0.8s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .auth-tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 35px;
        background: #f3f4f6;
        padding: 6px;
        border-radius: 16px;
      }

      .auth-tab {
        flex: 1;
        padding: 16px;
        border: none;
        background: transparent;
        border-radius: 12px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6b7280;
      }

      .auth-tab.active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
      }

      .auth-tab:hover:not(.active) {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 10px;
        color: #374151;
        font-weight: 600;
        font-size: 0.95em;
        letter-spacing: 0.3px;
      }

      .form-input {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1em;
        transition: all 0.3s ease;
        background: #f9fafb;
      }

      .form-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        background: white;
      }

      .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .btn-primary::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .btn-primary:hover::before {
        left: 100%;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
      }

      .btn-logout {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 12px 24px;
        font-size: 0.95em;
        border-radius: 12px;
      }

      .btn-logout:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
      }

      /* User Info Bar */
      .user-info-bar {
        display: none;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        padding: 25px 30px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2),
          0 0 0 1px rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .user-info-bar.active {
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: fadeInUp 0.8s ease;
      }

      .user-details {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid transparent;
        background: linear-gradient(white, white) padding-box,
          linear-gradient(135deg, #6366f1, #ec4899) border-box;
        box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
      }

      .user-avatar-placeholder {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2em;
        color: white;
        box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
      }

      /* Upload Section */
      .upload-section {
        display: none;
      }

      .upload-section.active {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
        gap: 30px;
        animation: fadeInUp 0.8s ease;
      }

      .upload-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        padding: 35px;
        border-radius: 24px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25),
          0 0 0 1px rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .upload-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.3);
      }

      .upload-card h3 {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 25px;
        font-size: 1.9em;
        font-weight: 700;
      }

      .upload-area {
        border: 3px dashed #c7d2fe;
        border-radius: 20px;
        padding: 50px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f0f4ff 0%, #fae8ff 100%);
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
      }

      .upload-area::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.5),
          transparent
        );
        transition: left 0.5s;
      }

      .upload-area:hover::before {
        left: 100%;
      }

      .upload-area:hover {
        background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        border-color: #8b5cf6;
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
      }

      .upload-icon {
        font-size: 4.5em;
        margin-bottom: 15px;
        animation: float 3s ease-in-out infinite;
        filter: drop-shadow(0 5px 15px rgba(139, 92, 246, 0.3));
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .file-input {
        display: none;
      }

      .preview-section {
        margin-top: 20px;
      }

      .preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .preview-item {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
      }

      .preview-item:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 30px rgba(139, 92, 246, 0.3);
      }

      .preview-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
      }

      .avatar-preview {
        width: 200px;
        height: 200px;
        margin: 0 auto 20px;
        position: relative;
      }

      .avatar-preview img {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        object-fit: cover;
        border: 6px solid transparent;
        background: linear-gradient(white, white) padding-box,
          linear-gradient(135deg, #6366f1, #ec4899) border-box;
        box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
      }

      .remove-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 18px;
      }

      .message {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border-left: 5px solid #28a745;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border-left: 5px solid #dc3545;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2em;
        }
        .upload-section.active {
          grid-template-columns: 1fr;
        }
        .user-info-bar.active {
          flex-direction: column;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üì∏ Upload Images</h1>
        <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu upload ·∫£nh</p>
      </div>

      <!-- Auth Container -->
      <div class="auth-container active" id="authContainer">
        <div class="auth-card">
          <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchTab('login')">
              üîê ƒêƒÉng Nh·∫≠p
            </button>
            <button class="auth-tab" onclick="switchTab('register')">
              üìù ƒêƒÉng K√Ω
            </button>
          </div>

          <!-- Login Form -->
          <div id="loginForm">
            <div class="form-group">
              <label>Username:</label>
              <input
                type="text"
                class="form-input"
                id="loginUsername"
                placeholder="Nh·∫≠p username..."
              />
            </div>
            <div class="form-group">
              <label>Password:</label>
              <input
                type="password"
                class="form-input"
                id="loginPassword"
                placeholder="Nh·∫≠p password..."
              />
            </div>
            <div id="loginMessage"></div>
            <button class="btn btn-primary" onclick="login()">
              üöÄ ƒêƒÉng Nh·∫≠p
            </button>
          </div>

          <!-- Register Form -->
          <div id="registerForm" style="display: none">
            <div class="form-group">
              <label>Username:</label>
              <input
                type="text"
                class="form-input"
                id="registerUsername"
                placeholder="Nh·∫≠p username..."
              />
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input
                type="email"
                class="form-input"
                id="registerEmail"
                placeholder="Nh·∫≠p email..."
              />
            </div>
            <div class="form-group">
              <label>Password:</label>
              <input
                type="password"
                class="form-input"
                id="registerPassword"
                placeholder="Nh·∫≠p password..."
              />
            </div>
            <div class="form-group">
              <label>H·ªç v√† T√™n:</label>
              <input
                type="text"
                class="form-input"
                id="registerFullName"
                placeholder="Nh·∫≠p h·ªç v√† t√™n (kh√¥ng b·∫Øt bu·ªôc)..."
              />
            </div>
            <div id="registerMessage"></div>
            <button class="btn btn-primary" onclick="register()">
              üìù ƒêƒÉng K√Ω
            </button>
          </div>
        </div>
      </div>

      <!-- User Info Bar -->
      <div class="user-info-bar" id="userInfoBar">
        <div class="user-details">
          <div id="userAvatarContainer"></div>
          <div>
            <h3 id="userDisplayName" style="color: #667eea"></h3>
            <p id="userDisplayEmail" style="color: #666"></p>
            <button
              style="
                padding: 5px 10px;
                font-size: 0.8em;
                margin-top: 5px;
                background: #10b981;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
              "
              onclick="checkToken()"
            >
              üîç Ki·ªÉm tra Token
            </button>
          </div>
        </div>
        <button class="btn btn-logout" onclick="logout()">üö™ ƒêƒÉng Xu·∫•t</button>
      </div>

      <!-- Upload Section -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-card">
          <h3>üë§ Upload Avatar</h3>
          <div
            class="upload-area"
            onclick="document.getElementById('avatarInput').click()"
          >
            <div class="upload-icon">üì∑</div>
            <p style="color: #667eea; font-size: 1.2em">
              <strong>Click ƒë·ªÉ ch·ªçn ·∫£nh avatar</strong>
            </p>
          </div>
          <input
            type="file"
            id="avatarInput"
            class="file-input"
            accept="image/*"
            onchange="previewAvatar(event)"
          />
          <div id="avatarPreview" class="preview-section" style="display: none">
            <div class="avatar-preview">
              <img id="avatarImg" src="" alt="Avatar Preview" />
            </div>
          </div>
          <div id="avatarLoading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #667eea">ƒêang upload...</p>
          </div>
          <div id="avatarMessage"></div>
          <button class="btn btn-primary" onclick="uploadAvatar()">
            üöÄ Upload Avatar
          </button>
        </div>

        <div class="upload-card">
          <h3>üñºÔ∏è Upload Nhi·ªÅu ·∫¢nh</h3>
          <div
            class="upload-area"
            onclick="document.getElementById('multipleInput').click()"
          >
            <div class="upload-icon">üìÅ</div>
            <p style="color: #667eea; font-size: 1.2em">
              <strong>Click ƒë·ªÉ ch·ªçn nhi·ªÅu ·∫£nh</strong>
            </p>
          </div>
          <input
            type="file"
            id="multipleInput"
            class="file-input"
            accept="image/*"
            multiple
            onchange="previewMultiple(event)"
          />
          <div
            id="multiplePreview"
            class="preview-section"
            style="display: none"
          >
            <h4>üñºÔ∏è Xem tr∆∞·ªõc (<span id="imageCount">0</span> ·∫£nh):</h4>
            <div id="multipleContainer" class="preview-container"></div>
          </div>
          <div id="multipleLoading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #667eea">ƒêang upload...</p>
          </div>
          <div id="multipleMessage"></div>
          <button class="btn btn-primary" onclick="uploadMultiple()">
            üöÄ Upload T·∫•t C·∫£
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000";
      let selectedFiles = [];
      let currentUser = null;

      window.addEventListener("load", () => {
        const token = localStorage.getItem("authToken");
        if (token) {
          verifyToken(token);
        }
      });

      function switchTab(tab) {
        const tabs = document.querySelectorAll(".auth-tab");
        tabs.forEach((t) => t.classList.remove("active"));

        if (tab === "login") {
          document.getElementById("loginForm").style.display = "block";
          document.getElementById("registerForm").style.display = "none";
          tabs[0].classList.add("active");
        } else {
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("registerForm").style.display = "block";
          tabs[1].classList.add("active");
        }
      }

      async function register() {
        const username = document
          .getElementById("registerUsername")
          .value.trim();
        const email = document.getElementById("registerEmail").value.trim();
        const password = document.getElementById("registerPassword").value;
        const fullName = document
          .getElementById("registerFullName")
          .value.trim();
        const messageDiv = document.getElementById("registerMessage");

        if (!username || !email || !password) {
          showMessage(
            messageDiv,
            "‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!",
            "error"
          );
          return;
        }

        try {
          const response = await fetch(`${API_URL}/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, email, password, fullName }),
          });

          const result = await response.json();
          if (result.success) {
            showMessage(
              messageDiv,
              "‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! Chuy·ªÉn sang ƒëƒÉng nh·∫≠p...",
              "success"
            );
            setTimeout(() => {
              switchTab("login");
              document.getElementById("loginUsername").value = username;
            }, 1500);
          } else {
            showMessage(
              messageDiv,
              `‚ùå ${result.message || "ƒêƒÉng k√Ω th·∫•t b·∫°i"}`,
              "error"
            );
          }
        } catch (error) {
          showMessage(messageDiv, `‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      async function login() {
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;
        const messageDiv = document.getElementById("loginMessage");

        if (!username || !password) {
          showMessage(messageDiv, "‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!", "error");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const result = await response.json();
          console.log("üîê Login result:", result);
          if (result.success) {
            console.log("üîê Saving token to localStorage:", result.data);
            localStorage.setItem("authToken", result.data);
            console.log(
              "üîê Token saved, verifying:",
              localStorage.getItem("authToken")
            );
            showMessage(messageDiv, "‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
            setTimeout(() => verifyToken(result.data), 1000);
          } else {
            showMessage(
              messageDiv,
              `‚ùå ${result.message || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i"}`,
              "error"
            );
          }
        } catch (error) {
          showMessage(messageDiv, `‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      async function verifyToken(token) {
        try {
          const response = await fetch(`${API_URL}/auth/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();
          if (result.success) {
            currentUser = result.data;
            showUserInterface();
          } else {
            localStorage.removeItem("authToken");
            showAuthInterface();
          }
        } catch (error) {
          localStorage.removeItem("authToken");
          showAuthInterface();
        }
      }

      function showUserInterface() {
        document.getElementById("authContainer").classList.remove("active");
        document.getElementById("userInfoBar").classList.add("active");
        document.getElementById("uploadSection").classList.add("active");

        document.getElementById("userDisplayName").textContent =
          currentUser.fullName || currentUser.username;
        document.getElementById("userDisplayEmail").textContent =
          currentUser.email;

        const avatarContainer = document.getElementById("userAvatarContainer");
        if (currentUser.avatarURL) {
          avatarContainer.innerHTML = `<img src="${API_URL}${currentUser.avatarURL}" class="user-avatar">`;
        } else {
          avatarContainer.innerHTML = `<div class="user-avatar-placeholder">üë§</div>`;
        }
      }

      function showAuthInterface() {
        document.getElementById("authContainer").classList.add("active");
        document.getElementById("userInfoBar").classList.remove("active");
        document.getElementById("uploadSection").classList.remove("active");
      }

      function logout() {
        localStorage.removeItem("authToken");
        currentUser = null;
        showAuthInterface();
        showMessage(
          document.getElementById("loginMessage"),
          "‚úÖ ƒê√£ ƒëƒÉng xu·∫•t!",
          "success"
        );
      }

      function checkToken() {
        const token = localStorage.getItem("authToken");
        console.log("üîê Current token:", token);
        console.log("üîê Token exists:", !!token);
        console.log("üîê Token length:", token ? token.length : 0);
        console.log("üîê Current user:", currentUser);

        if (token) {
          alert(
            "‚úÖ Token t·ªìn t·∫°i!\n\nToken: " +
              token.substring(0, 50) +
              "...\nLength: " +
              token.length
          );
        } else {
          alert("‚ùå Kh√¥ng t√¨m th·∫•y token!\n\nVui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
        }
      }

      function previewAvatar(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("avatarImg").src = e.target.result;
            document.getElementById("avatarPreview").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      }

      function previewMultiple(event) {
        selectedFiles = Array.from(event.target.files);
        const container = document.getElementById("multipleContainer");
        container.innerHTML = "";
        document.getElementById("imageCount").textContent =
          selectedFiles.length;

        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const div = document.createElement("div");
            div.className = "preview-item";
            div.innerHTML = `
                        <img src="${e.target.result}">
                        <button class="remove-btn" onclick="removeImage(${index})">√ó</button>
                    `;
            container.appendChild(div);
          };
          reader.readAsDataURL(file);
        });

        document.getElementById("multiplePreview").style.display = "block";
      }

      function removeImage(index) {
        selectedFiles.splice(index, 1);
        const dt = new DataTransfer();
        selectedFiles.forEach((file) => dt.items.add(file));
        document.getElementById("multipleInput").files = dt.files;
        previewMultiple({ target: { files: dt.files } });
        if (selectedFiles.length === 0) {
          document.getElementById("multiplePreview").style.display = "none";
        }
      }

      async function uploadAvatar() {
        const token = localStorage.getItem("authToken");
        const fileInput = document.getElementById("avatarInput");
        const messageDiv = document.getElementById("avatarMessage");
        const loadingDiv = document.getElementById("avatarLoading");

        if (!fileInput.files[0]) {
          showMessage(messageDiv, "‚ùå Vui l√≤ng ch·ªçn ·∫£nh!", "error");
          return;
        }

        const formData = new FormData();
        formData.append("avatar", fileInput.files[0]);

        try {
          loadingDiv.style.display = "block";
          messageDiv.innerHTML = "";

          const response = await fetch(`${API_URL}/users/upload-avatar`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          const result = await response.json();
          loadingDiv.style.display = "none";

          if (result.success) {
            showMessage(messageDiv, `‚úÖ Upload th√†nh c√¥ng!`, "success");
            verifyToken(token);
          } else {
            showMessage(messageDiv, `‚ùå ${result.message}`, "error");
          }
        } catch (error) {
          loadingDiv.style.display = "none";
          showMessage(messageDiv, `‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      async function uploadMultiple() {
        const token = localStorage.getItem("authToken");
        const fileInput = document.getElementById("multipleInput");
        const messageDiv = document.getElementById("multipleMessage");
        const loadingDiv = document.getElementById("multipleLoading");

        console.log("üîê Token from localStorage:", token);
        console.log("üîê Token exists:", !!token);
        console.log("üîê Token length:", token ? token.length : 0);

        // Ki·ªÉm tra token tr∆∞·ªõc
        if (!token || token === "null" || token === "undefined") {
          showMessage(messageDiv, "‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!", "error");
          console.error("‚ùå No valid token found");
          return;
        }

        console.log("üîç Debug - selectedFiles length:", selectedFiles.length);
        console.log(
          "üîç Debug - fileInput.files length:",
          fileInput.files.length
        );

        if (selectedFiles.length === 0 && fileInput.files.length === 0) {
          showMessage(messageDiv, "‚ùå Vui l√≤ng ch·ªçn ·∫£nh!", "error");
          return;
        }

        const formData = new FormData();

        // S·ª≠ d·ª•ng fileInput.files thay v√¨ selectedFiles ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ file
        const filesToUpload =
          selectedFiles.length > 0
            ? selectedFiles
            : Array.from(fileInput.files);

        console.log("üîç Debug - filesToUpload:", filesToUpload.length);

        // Ki·ªÉm tra k√≠ch th∆∞·ªõc m·ªói file
        const maxSize = 10 * 1024 * 1024; // 10MB
        let totalSize = 0;
        for (let file of filesToUpload) {
          if (file.size > maxSize) {
            showMessage(
              messageDiv,
              `‚ùå File "${file.name}" qu√° l·ªõn! T·ªëi ƒëa 10MB m·ªói file.`,
              "error"
            );
            return;
          }
          totalSize += file.size;
        }

        console.log(
          "üîç Debug - Total size:",
          (totalSize / (1024 * 1024)).toFixed(2),
          "MB"
        );

        filesToUpload.forEach((file, index) => {
          console.log(
            `üîç Debug - Appending file ${index}:`,
            file.name,
            file.type,
            (file.size / (1024 * 1024)).toFixed(2) + " MB"
          );
          formData.append("files", file);
        });

        try {
          loadingDiv.style.display = "block";
          messageDiv.innerHTML = "";

          console.log(
            "üîç Debug - Sending request to:",
            `${API_URL}/files/upload-multiple`
          );
          console.log(
            "üîç Debug - Token:",
            token ? "C√≥ token" : "Kh√¥ng c√≥ token"
          );

          const response = await fetch(`${API_URL}/files/upload-multiple`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          console.log("üîç Debug - Response status:", response.status);
          console.log("üîç Debug - Response ok:", response.ok);

          const result = await response.json();
          console.log("üîç Debug - Result:", result);

          loadingDiv.style.display = "none";

          if (result.success) {
            showMessage(
              messageDiv,
              `‚úÖ Upload th√†nh c√¥ng ${filesToUpload.length} ·∫£nh!`,
              "success"
            );
            selectedFiles = [];
            document.getElementById("multipleInput").value = "";
            document.getElementById("multiplePreview").style.display = "none";
          } else {
            showMessage(
              messageDiv,
              `‚ùå ${result.message || "Upload th·∫•t b·∫°i"}`,
              "error"
            );
          }
        } catch (error) {
          console.error("‚ùå Error details:", error);
          loadingDiv.style.display = "none";
          showMessage(messageDiv, `‚ùå L·ªói: ${error.message}`, "error");
        }
      }

      function showMessage(element, message, type) {
        element.innerHTML = `<div class="message ${type}">${message}</div>`;
      }
    </script>
  </body>
</html>
